<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek AI Chat - Multi-Round Conversations</title>
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/progress-indicator.css">
    <script src="/js/progress-indicator.js"></script>
    <script src="/js/realtime.js"></script>
    <script src="/js/streaming-chat.js"></script>
    <style>
        .message { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">DeepSeek AI Chat</h1>
                <div class="flex space-x-6">
                    <a href="/" class="text-gray-300 hover:text-white">Generator</a>
                    <a href="/dashboard.html" class="text-gray-300 hover:text-white">Dashboard</a>
                    <a href="/analytics.html" class="text-gray-300 hover:text-white">Analytics</a>
                    <a href="/rag-database.html" class="text-gray-300 hover:text-white">RAG Database</a>
                    <a href="/chat.html" class="text-blue-400 font-medium">Chat</a>
                    <a href="/docs.html" class="text-gray-300 hover:text-white">Docs</a>
                    <a href="/admin.html" class="text-gray-300 hover:text-white">Admin</a>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <select id="platformSelect" class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm">
                    <option value="replit">Replit</option>
                    <option value="lovable">Lovable</option>
                    <option value="bolt">Bolt</option>
                    <option value="cursor">Cursor</option>
                    <option value="windsurf">Windsurf</option>
                </select>
                <button id="newChatBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">New Chat</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-80 bg-gray-800 border-r border-gray-700 p-4">
            <h3 class="text-lg font-semibold mb-4">Chat Sessions</h3>
            <div id="chatSessions" class="space-y-2">
                <!-- Chat sessions will be populated here -->
            </div>
            
            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-400 mb-2">RAG Context</h4>
                <div id="ragContext" class="text-xs text-gray-500">
                    Select a platform and start chatting to see relevant documentation
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold" id="chatTitle">DeepSeek AI Assistant</h2>
                        <p class="text-gray-400 text-sm" id="chatSubtitle">Multi-round conversation with RAG integration</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div id="connectionIndicator" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-400">Connected</span>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 space-y-4">
                <div class="message">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold">AI</div>
                        <div class="flex-1">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-gray-300">Hello! I'm your DeepSeek AI assistant with access to comprehensive platform documentation. How can I help you build your application today?</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-gray-800 border-t border-gray-700 p-6">
                <div class="flex space-x-4">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Ask about development, features, APIs, or anything else..."
                        class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        maxlength="1000"
                    >
                    <button 
                        id="sendBtn" 
                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 px-6 py-3 rounded-lg font-medium transition-colors"
                    >
                        Send
                    </button>
                </div>
                <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                    <span>Press Enter to send â€¢ Shift+Enter for new line</span>
                    <span id="charCount">0/1000</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ChatInterface {
            constructor() {
                this.currentSessionId = null;
                this.platform = 'replit';
                this.sessions = new Map();
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.platformSelect = document.getElementById('platformSelect');
                this.newChatBtn = document.getElementById('newChatBtn');
                this.chatSessions = document.getElementById('chatSessions');
                this.ragContext = document.getElementById('ragContext');
                this.charCount = document.getElementById('charCount');
                this.chatTitle = document.getElementById('chatTitle');
                this.chatSubtitle = document.getElementById('chatSubtitle');
            }

            bindEvents() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.messageInput.addEventListener('input', () => {
                    const length = this.messageInput.value.length;
                    this.charCount.textContent = `${length}/1000`;
                });
                this.platformSelect.addEventListener('change', (e) => {
                    this.platform = e.target.value;
                    this.updateChatInfo();
                });
                this.newChatBtn.addEventListener('click', () => this.startNewChat());
            }

            updateChatInfo() {
                this.chatTitle.textContent = `${this.platform.charAt(0).toUpperCase() + this.platform.slice(1)} Assistant`;
                this.chatSubtitle.textContent = `Specialized in ${this.platform} development with RAG integration`;
            }

            startNewChat() {
                this.currentSessionId = null;
                this.clearMessages();
                this.addMessage('ai', 'Hello! I\'m your DeepSeek AI assistant with access to comprehensive platform documentation. How can I help you build your application today?');
            }

            clearMessages() {
                this.messagesContainer.innerHTML = '';
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                this.messageInput.value = '';
                this.charCount.textContent = '0/1000';
                
                // Add user message
                this.addMessage('user', message);
                
                // Show progress indicator
                window.ProgressIndicator.show(this.chatContainer, {
                    title: 'Processing Chat Message',
                    platform: this.platform,
                    query: message
                });
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message,
                            sessionId: this.currentSessionId,
                            platform: this.platform
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    // Update session ID
                    this.currentSessionId = data.sessionId;
                    
                    // Complete progress indicator
                    window.ProgressIndicator.complete({
                        success: true,
                        tokensUsed: data.tokensUsed || 0
                    });
                    
                    // Add AI response
                    const responseContent = data.response || 'No response content received';
                    this.addMessage('ai', responseContent, data.reasoning);
                    
                    // Update RAG context
                    this.updateRagContext(data.ragContext || []);
                    
                    // Update session list
                    this.updateSessionList();
                    
                } catch (error) {
                    // Complete progress indicator with error
                    window.ProgressIndicator.complete({
                        success: false,
                        error: error.message
                    });
                    
                    this.addMessage('ai', 'Sorry, I encountered an error. Please try again.', null, true);
                    console.error('Chat error:', error);
                }
            }

            addMessage(sender, content, reasoning = null, isError = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                const isUser = sender === 'user';
                const bgColor = isUser ? 'bg-blue-600' : (isError ? 'bg-red-600' : 'bg-gray-800');
                const textColor = isUser ? 'text-blue-100' : 'text-gray-300';
                
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}">
                        <div class="w-8 h-8 ${isUser ? 'bg-blue-600' : (isError ? 'bg-red-600' : 'bg-gray-600')} rounded-full flex items-center justify-center text-sm font-bold">
                            ${isUser ? 'You' : 'AI'}
                        </div>
                        <div class="flex-1 max-w-3xl">
                            <div class="${bgColor} rounded-lg p-4">
                                <div class="${textColor} whitespace-pre-wrap">${this.escapeHtml(content || 'Empty content')}</div>
                                ${reasoning ? `
                                    <details class="mt-3">
                                        <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-300">View AI Reasoning</summary>
                                        <div class="mt-2 text-xs text-gray-400 bg-gray-900 p-2 rounded whitespace-pre-wrap">
                                            ${this.escapeHtml(reasoning)}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                            <div class="text-xs text-gray-500 mt-1 ${isUser ? 'text-right' : ''}">
                                ${new Date().toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `;
                
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'message typing-indicator';
                typingDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-sm font-bold">AI</div>
                        <div class="flex-1">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.messagesContainer.appendChild(typingDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            updateRagContext(ragResults) {
                if (ragResults.length === 0) {
                    this.ragContext.innerHTML = '<div class="text-xs text-gray-500">No relevant documentation found</div>';
                    return;
                }

                const contextHtml = ragResults.map(doc => `
                    <div class="bg-gray-700 rounded p-2 mb-2">
                        <div class="font-medium text-xs text-blue-400">${doc.title}</div>
                        <div class="text-xs text-gray-300 mt-1">${doc.snippet}</div>
                        <div class="text-xs text-gray-500 mt-1">Relevance: ${doc.relevanceScore}</div>
                    </div>
                `).join('');

                this.ragContext.innerHTML = `
                    <div class="text-xs font-medium text-gray-400 mb-2">Relevant Documentation:</div>
                    ${contextHtml}
                `;
            }

            updateSessionList() {
                if (!this.currentSessionId) return;
                
                // Add session to list if not exists
                if (!this.sessions.has(this.currentSessionId)) {
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = 'bg-gray-700 hover:bg-gray-600 rounded p-3 cursor-pointer transition-colors';
                    sessionDiv.innerHTML = `
                        <div class="text-sm font-medium">${this.platform} Chat</div>
                        <div class="text-xs text-gray-400">${new Date().toLocaleTimeString()}</div>
                    `;
                    
                    this.chatSessions.insertBefore(sessionDiv, this.chatSessions.firstChild);
                    this.sessions.set(this.currentSessionId, sessionDiv);
                }
            }
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize chat interface
        document.addEventListener('DOMContentLoaded', () => {
            new ChatInterface();
        });
    </script>
</body>
</html>